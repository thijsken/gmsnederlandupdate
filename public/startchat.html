<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico.png" type="image/x-icon" />
  <title>GMS_Nederland Live Chat Support</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #004aad, #1a73e8);
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #222;
    }

    #chat-widget {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 74, 173, 0.25);
      width: 100%;
      max-width: 440px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: 16px;
      line-height: 1.4;
    }

    #chat-header {
      background: #004aad;
      color: #fff;
      padding: 22px 28px;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: center;
      letter-spacing: 1px;
      user-select: none;
      box-shadow: inset 0 -3px 6px rgba(0,0,0,0.15);
    }

    #start-screen {
      padding: 28px 32px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #customer-name {
      padding: 16px 20px;
      font-size: 1rem;
      border: 2px solid #ccc;
      border-radius: 16px;
      transition: border-color 0.25s ease;
    }
    #customer-name:focus {
      border-color: #004aad;
      outline: none;
      box-shadow: 0 0 6px #1a73e8aa;
    }

    #start-chat {
      background: #004aad;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
      padding: 16px 0;
      border-radius: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #start-chat:disabled {
      background: #a3bff7;
      cursor: not-allowed;
    }
    #start-chat:not(:disabled):hover {
      background: #003780;
    }

    #question-type {
      padding: 16px 20px;
      font-size: 1rem;
      border: 2px solid #ccc;
      border-radius: 16px;
      transition: border-color 0.25s ease;
    }
    #question-type:focus {
      border-color: #004aad;
      outline: none;
      box-shadow: 0 0 6px #1a73e8aa;
    }

    #chat-container {
      display: none;
      flex-direction: column;
      height: 500px;
      background: #f5f7fb;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scrollbar-width: thin;
      scrollbar-color: #004aad #d1d9e6;
    }
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: #d1d9e6;
      border-radius: 4px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #004aad;
      border-radius: 4px;
    }

    .message {
      max-width: 75%;
      padding: 14px 22px;
      border-radius: 28px;
      font-size: 1rem;
      line-height: 1.4;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.customer {
      align-self: flex-end;
      background: #d0f0c0;
      color: #1e3d00;
      border-bottom-right-radius: 8px;
      font-weight: 600;
    }

    .message.agent {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #bbb;
      color: #222;
      border-bottom-left-radius: 8px;
      font-weight: 500;
    }

    #input-area {
      padding: 18px 28px;
      border-top: 1.5px solid #ccc;
      display: flex;
      gap: 14px;
      background: #fff;
    }

    #msg-input {
      flex-grow: 1;
      font-size: 1rem;
      padding: 16px 20px;
      border: 2px solid #ccc;
      border-radius: 18px;
      transition: border-color 0.25s ease;
    }
    #msg-input:focus {
      border-color: #004aad;
      outline: none;
      box-shadow: 0 0 8px #1a73e8cc;
    }

    #send-btn {
      background: #004aad;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      padding: 16px 24px;
      border-radius: 18px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #send-btn:disabled {
      background: #a3bff7;
      cursor: not-allowed;
    }
    #send-btn:not(:disabled):hover {
      background: #003780;
    }

    #typing-indicator {
      padding: 0 28px 8px;
      font-size: 0.9rem;
      color: #555;
      display: none;
    }

    @media (max-width: 480px) {
      #chat-widget {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
        box-shadow: none;
      }
      #chat-container {
        height: calc(100vh - 70px);
      }
      #start-screen {
        padding: 20px 24px;
      }
      #messages {
        padding: 16px 20px;
      }
      #input-area {
        padding: 14px 20px;
      }
    }

    .visually-hidden { 
      position: absolute !important; 
      height: 1px; 
      width: 1px; 
      overflow: hidden; 
      clip: rect(1px, 1px, 1px, 1px); 
      white-space: nowrap; 
    }
  </style>
</head>
<body>
  <div id="typing-indicator" aria-live="polite" aria-atomic="true">GMS Nederland is aan het typen...</div>

  <div id="chat-widget" role="region" aria-label="Live chat ondersteuning GMSNederland">
    <div id="chat-header">GMS_Nederland_Live_Chat</div>

    <section id="start-screen">
      <label for="customer-name" class="visually-hidden">Jouw naam</label>
      <input type="text" id="customer-name" placeholder="Voer je naam in..." autocomplete="off" aria-required="true" />
      
      <label for="question-type" class="visually-hidden">Kies je vraagsoort</label>
      <select id="question-type" aria-required="true">
        <option value="" disabled selected>-- Kies je vraag --</option>
        <option value="support_met_GMS_samenwerking">Support met GMS samenwerking</option>
        <option value="klachten_mod">Klachten / Mod</option>
        <option value="anders">Anders</option>
      </select>

      <button id="start-chat" disabled aria-disabled="true" aria-label="Start de chat">Start chat</button>
    </section>

    <section id="chat-container" aria-live="polite" aria-relevant="additions" aria-atomic="false">
      <div id="messages" role="log" aria-live="polite" aria-atomic="false"></div>
      <form id="input-area" onsubmit="return false;">
        <label for="msg-input" class="visually-hidden">Typ je bericht</label>
        <input type="text" id="msg-input" placeholder="Typ je bericht..." autocomplete="off" aria-label="Typ je bericht" />
        <button id="send-btn" disabled aria-disabled="true" aria-label="Verstuur bericht">Verstuur</button>
      </form>
    </section>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAuHf66GFU9KKFVkJPAS3a1qaX2nG9xH_s",
    authDomain: "gmsnederland-3029e.firebaseapp.com",
    projectId: "gmsnederland-3029e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const customerNameInput = document.getElementById('customer-name');
  const startChatBtn = document.getElementById('start-chat');
  const questionTypeSelect = document.getElementById('question-type');

  const chatContainer = document.getElementById('chat-container');
  const messagesDiv = document.getElementById('messages');
  const msgInput = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');

  const typingIndicator = document.getElementById('typing-indicator');

  let chatDocRef = null;
  let unsubscribeMessages = null;

  function updateStartButtonState() {
    const nameFilled = customerNameInput.value.trim() !== '';
    const questionSelected = questionTypeSelect.value !== '';
    startChatBtn.disabled = !(nameFilled && questionSelected);
    startChatBtn.setAttribute('aria-disabled', startChatBtn.disabled.toString());
  }

  customerNameInput.addEventListener('input', updateStartButtonState);
  questionTypeSelect.addEventListener('change', updateStartButtonState);

  msgInput.addEventListener('input', () => {
    const hasText = msgInput.value.trim() !== '';
    sendBtn.disabled = !hasText;
    sendBtn.setAttribute('aria-disabled', (!hasText).toString());

    if(chatDocRef) {
      updateDoc(chatDocRef, { customerTyping: hasText }).catch(console.error);
    }
  });

  startChatBtn.addEventListener('click', async () => {
    const name = customerNameInput.value.trim();
    const questionType = questionTypeSelect.value;
    if(!name || !questionType) return;

    chatDocRef = await addDoc(collection(db, 'chats'), {
      customerName: name,
      questionType: questionType,
      messages: [],
      createdAt: serverTimestamp(),
      chatStatus: 'active',
      customerTyping: false,
      agentTyping: false
    });

    document.getElementById('start-screen').style.display = 'none';
    chatContainer.style.display = 'flex';

    listenForMessages();
    msgInput.focus();
  });

  function listenForMessages() {
    if(!chatDocRef) return;

    if(unsubscribeMessages) unsubscribeMessages();

    unsubscribeMessages = onSnapshot(doc(db, 'chats', chatDocRef.id), (docSnap) => {
      if(!docSnap.exists()) return;

      const data = docSnap.data();

      renderMessages(data.messages || []);

      if(data.agentTyping) {
        typingIndicator.style.display = 'block';
      } else {
        typingIndicator.style.display = 'none';
      }

      if(data.chatStatus === 'closed') {
        msgInput.disabled = true;
        sendBtn.disabled = true;
        typingIndicator.textContent = "De chat is gesloten.";
        typingIndicator.style.display = 'block';
      }
    });
  }

  function renderMessages(messages) {
    messagesDiv.innerHTML = '';
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.sender === 'customer' ? 'customer' : 'agent');
      div.textContent = msg.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  sendBtn.addEventListener('click', async () => {
    const text = msgInput.value.trim();
    if(!text || !chatDocRef) return;

    const chatRef = doc(db, 'chats', chatDocRef.id);
    const docSnap = await getDoc(chatRef);
    let currentMessages = [];
    if(docSnap.exists()) {
      currentMessages = docSnap.data().messages || [];
    }

    const newMessage = {
      text,
      sender: 'customer',
      timestamp: Timestamp.now()  // Vervang serverTimestamp() hier
    };

    currentMessages.push(newMessage);

    await updateDoc(chatRef, {
      messages: currentMessages,
      customerTyping: false
    });

    msgInput.value = '';
    sendBtn.disabled = true;
    sendBtn.setAttribute('aria-disabled', 'true');
  });

  msgInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !sendBtn.disabled) {
      e.preventDefault();
      sendBtn.click();
    }
  });
</script>
</body>
</html>
